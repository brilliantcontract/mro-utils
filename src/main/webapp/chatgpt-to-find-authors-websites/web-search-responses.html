<!DOCTYPE html>
<html lang="en">
    <head>
        <title>JavaScript documentation</title>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <!-- Bootstrap / JQuery / Knockout. -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous" />
        <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js" integrity="sha384-+sLIOodYLS7CIrQpBjl+C7nPvqq+FbNUBDunl/OZv93DB7Ln/533i8e/mZXLi/P+" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.0/knockout-min.js"></script>
    </head>
    <body class="container mt-3">
        <h1 class="h2 mb-3 mt-5">Responses API Web Search</h1>
        <h5 class="mb-4">OpenAI gpt-4o using web search tool</h5>

        <form>
            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <label class="input-group-text">API Key</label>
                </div>
                <input type="password" data-bind="value: apiKey" class="form-control" />
            </div>

            <div class="input-group mb-4">
                <div class="input-group-prepend">
                    <label class="input-group-text">Query</label>
                </div>
                <input type="text" data-bind="value: query" class="form-control" />
            </div>

            <input type="button" data-bind="click: send" value="Send" class="btn btn-outline-dark btn-lg" />
        </form>

        <h3 class="h4 mt-5">Answer</h3>
        <div class="border border-dark shadow p-3 mb-5 bg-white rounded">
            <pre data-bind="text: answer" class="text-break"></pre>
        </div>

        <script src="./responses-utils.js"></script>
        <script>
            function openDb() {
                return new Promise(function (resolve, reject) {
                    const req = indexedDB.open('responseSearch', 1);
                    req.onupgradeneeded = function (e) {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('config')) {
                            db.createObjectStore('config');
                        }
                    };
                    req.onsuccess = function (e) { resolve(e.target.result); };
                    req.onerror = function (e) { reject(e.target.error); };
                });
            }

            async function loadApiKey() {
                const db = await openDb();
                return new Promise(function (resolve, reject) {
                    const tx = db.transaction('config', 'readonly');
                    const req = tx.objectStore('config').get('apiKey');
                    req.onsuccess = function () { resolve(req.result || ''); };
                    req.onerror = function (e) { reject(e.target.error); };
                });
            }

            async function saveApiKey(key) {
                const db = await openDb();
                return new Promise(function (resolve, reject) {
                    const tx = db.transaction('config', 'readwrite');
                    tx.objectStore('config').put(key, 'apiKey');
                    tx.oncomplete = function () { resolve(); };
                    tx.onerror = function (e) { reject(e.target.error); };
                });
            }

            async function askOpenAi(question, key) {
                const apiRequest = new Request('https://api.openai.com/v1/responses', {
                    method: 'POST',
                    headers: {
                        Authorization: 'Bearer ' + key,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(buildResponsesBody(question))
                });

                try {
                    const response = await fetch(apiRequest);
                    const json = await response.json();
                    if (json.error) {
                        return json.error.message;
                    }
                    return json.output_text;
                } catch (ex) {
                    return 'Error: ' + ex;
                }
            }

            var FormModel = function () {
                var self = this;
                self.apiKey = ko.observable('');
                self.query = ko.observable('What are the top 3 news headlines today?');
                self.answer = ko.observable('');

                loadApiKey().then(function (key) {
                    self.apiKey(key);
                });
                self.apiKey.subscribe(function (val) {
                    saveApiKey(val);
                });

                self.send = function () {
                    if (!self.query().trim() || !self.apiKey().trim()) {
                        self.answer('Please enter API key and query.');
                        return;
                    }
                    self.answer('Query has been sent to chatbot. Waiting answer \u2026');
                    askOpenAi(self.query(), self.apiKey())
                        .then(self.answer)
                        .catch(function (err) {
                            console.error(err);
                            self.answer('Error: ' + err.message);
                        });
                };
            };

            ko.applyBindings(new FormModel());
        </script>
    </body>
</html>
